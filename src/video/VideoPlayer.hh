#pragma once

#include <glad/glad.h>

// This comment is keeping the peace between glad and glfw
// Removing glad causes some errors at compile-time
// Refer to GLWin.cc for a similar situation
#include <GLFW/glfw3.h>
#include <mpv/client.h>
#include <mpv/render_gl.h>

#include "opengl/Shape.hh"
#include "util/Ex.hh"

class VideoPlayer : public Shape {
 private:
  // c++ wont let you pass something like &4 as a parameter, so we create an
  // advanced control variable within the class to make sure there's a valid
  // address to point to
  int advancedControl;

  // location to draw the video on screen
  float x, y, width, height;
  // how much to crop the drawn video by
  float xLeft, xRight, yTop, yBottom;
  // places to put the fbo and texture generated by opengl
  uint32_t fbo, texture;

  // standard mpv context for playing things
  mpv_handle *mpv;

  // mpv render context that will draw video frames into fbo
  mpv_render_context *mpv_gl;

  // struct with 3 internal bits
  mpv_opengl_fbo fboParams;
  // struct where we only end up setting one value
  mpv_opengl_init_params openglInitParams;

  // a list of lists, where each iternal list contains an enum in the first slot
  // and some kind of data in the second slot
  // this will be passed once to mpv giving it initial parameters when creating
  // an mpv render context
  mpv_render_param initialRenderParams[4];
  // list of lists, where each internal list contains an enum in the first slot,
  // and data in the second
  // this gets passed to mpv each time the mpv render context redraws, so it's
  // values could change and affect the output of what shows up on screen
  mpv_render_param redrawParams[2];

  // most mpv functions that can fail return an integer, where 0 is success, and
  // anything else is some kind of error
  // this function checks whether a function returned an error code, and if so
  // prints to the screen what that error code means (from mpv_error_string),
  // then throws a general exception from grail, halting the program
  inline void checkError(int status) {
    if (status < 0) {
      printf("mpv API error: %s\n", mpv_error_string(status));
      throw Ex1(Errcode::MPV_FAILURE);
    }
  }

  bool isPlaying;

 public:
  VideoPlayer(Canvas *c, float x, float y, int width, int height);
  ~VideoPlayer();

  // get rid of the copy constructors
  VideoPlayer(const VideoPlayer &orig) = delete;
  VideoPlayer &operator=(const VideoPlayer &orig) = delete;

  void init();
  void update();
  void render();

  void loadFile(std::string filePath);
  void loadPlaylist(std::string filePath, bool append = false);

  void setVolume(int volume);
  void seekLocation(std::string time, std::string type = "relative");
  void revertSeek();

  void playlistNext();
  void playlistPrev();

  void cropVideo(float xLeft, float xRight, float yTop, float yBottom);

  void setPaused();
  void setPlaying();
  void togglePause();
};
